// Generated by CoffeeScript 1.6.3
(function() {
  var $messagePanel, $progress, $progressBar, $submitBth, $uploadBtn, $videoName, r, showError, showInfo;

  $progress = $('#progress');

  $progressBar = $progress.find('.progress-bar');

  $uploadBtn = $('#upload-btn');

  $videoName = $("#video-name");

  $submitBth = $('#submit_btn');

  $messagePanel = $("#message");

  showError = function(text) {
    return $messagePanel.removeClass('hidden alert-info').addClass('alert-danger').text(text);
  };

  showInfo = function(text) {
    return $messagePanel.removeClass('hidden alert-danger').addClass('alert-info').text(text);
  };

  r = new Resumable({
    target: '/upload',
    chunkSize: 1 * 1024 * 1024,
    simultaneousUploads: 4,
    testChunks: false,
    throttleProgressCallbacks: 1,
    maxFiles: 1,
    fileType: ['mp4'],
    fileTypeErrorCallback: function(file, errors) {
      return showError('请上传MP4格式的视频!');
    }
  });

  if (!r.support) {
    $("#upload-form").hide();
    showError('您现在用的浏览器不支持该功能!');
  } else {
    r.assignDrop($('#upload-form')[0]);
    r.assignBrowse($('#upload-btn')[0]);
    r.on('fileAdded', function(file) {
      $messagePanel.addClass('hidden');
      $progress.removeClass('hidden');
      $uploadBtn.parent().addClass('hidden');
      return r.upload();
    });
    r.on('pause', function() {});
    r.on('complete', function() {});
    r.on('fileSuccess', function(file, message) {
      $videoName.removeClass('hidden');
      $videoName.find('input[name=name]').val(file.fileName.substr(0, file.fileName.lastIndexOf('.')));
      $('input[name=filename]').val(file.fileName);
      return $.post('/video/merge', {
        filename: file.fileName,
        identifier: file.uniqueIdentifier
      }, function(res) {
        var data;
        if (res.status === 'success') {
          data = res.data || {};
          $('input[name=time]').val(data.time);
          $('input[name=format]').val(data.format);
          $('input[name=path]').val(data.path);
          $('input[name=poster]').val(data.poster);
          $('input[name=duration]').val(data.duration);
          if (data.poster) {
            $("#thumb").removeClass('hidden').find('img').attr('src', '/video/thumbnail/' + data.poster);
          }
          $submitBth.removeClass('hidden');
          return $messagePanel.addClass('hidden');
        } else {
          return showError('合并文件失败!');
        }
      });
    });
    r.on('fileError', function(file, message) {
      showError('上传出错');
      return r.cancel();
    });
    r.on('fileProgress', function(file, message) {
      var progress;
      progress = Math.floor(file.progress() * 100);
      $progressBar.css({
        'width': progress + '%'
      });
      return $progressBar.find('span').text(progress + '%');
    });
    r.on('cancel', function() {});
    r.on('uploadStart', function() {});
    $submitBth.click(function() {
      var data;
      data = $("#upload-form").serialize();
      return $.ajax({
        url: '/video/add',
        data: data,
        type: 'POST',
        dataType: 'json',
        beforeSend: function() {
          return $submitBth.addClass('hidden');
        },
        complete: function() {
          return $submitBth.removeClass('hidden');
        },
        success: function(res) {
          if (res.status === 'success') {
            return window.location.href = '/video/av/' + res.data;
          } else {
            console.log(res.message);
            return showError('添加视频出错!');
          }
        }
      });
    });
  }

}).call(this);
